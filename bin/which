#!/bin/bash

### Imports ###################################################################

savepath="$PATH"
source ScriptFunctions
Import Log
Import OptionParser

### Options ###################################################################

scriptDescription="Display real location of an executable file."
scriptCredits="Released under the GNU GPL."
helpOnNoArguments=yes
scriptUsage="<executable>"
scriptExample="ls"
Parse_Options "$@"

### Operation #################################################################

export PATH="$savepath"
fakepath=`type -p "$(Arg 1)"`
if [ ! "$fakepath" ]
then
    if [ -x "/bin/$(Arg 1)" ]
    then
        fakepath="/bin/$(Arg 1)"
    else
        echo "$(Arg 1) not found, or it's not a program." >&2
        exit 1
    fi
elif [ ! "$fakepath" ]
then
   echo "$(Arg 1) not found, or it's not a program." >&2
   exit 1
fi

target="$(readlink -f "$fakepath")"

# Resolve executable names mounted on overlayfs
if [ "$(dirname "$target")" = "$goboSystem/Index/bin" ] && [ ! -z "$GOBOLINUX_RUNNER" ]
then
   overlay_dirs="$(grep "^overlay $goboSystem/Index/bin" /proc/self/mounts | sed 's/.*lowerdir=\(.*\),upperdir=.*/\1/g')"
   for overlay_dir in $(echo "$overlay_dirs" | tr -s ":" "\n" | grep -v "$goboSystem/Index/bin")
   do
      if [ -e "$overlay_dir/$(Arg 1)" ]
      then
         target="$(readlink -f "$overlay_dir/$(Arg 1)")"
         break
      fi
   done
fi

echo "$target"

exit 0
